<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="refresh" content="300" />
    <meta name='robots' content='noindex,nofollow' />
    <title>Wetter</title>
    <style>
        html {
            background-color: #2d3036;
        }

        body {
            width: 820px;
            font-family: Verdana, sans-serif;
            font-size: 1.5em;
            margin: 0.5em;
            text-align: center;
            color: #fff;
        }

        table {
            table-layout: fixed;
        }

        table td {
            border-top: solid;
            border-color: #fff;
        }

        p {
            white-space: normal;
        }

        .name {
            font-weight: bold;
            text-align: left;
        }

        .warnings {
            margin-top: 0.5em;
            padding: 0.5em;
            border: solid;
            border-color: #fff;
        }

        .avalanche {
            margin-top: 0.5em;
            padding: 0.5em;
            border: solid;
            border-color: #fff;
        }

        .hidden {
            display: none;
        }

        .warningContainer {
            display: none;
        }

        .warningName {
            font-weight: bold;
            margin: 0;
        }

        .warningDesc {
            margin: 0;
        }

        .warningCount {
            margin: 0;
            text-align: right;
        }

        .warning {
            color: #f60;
        }

        .red {
            color: red;
        }

        .blue {
            color: lightblue;
        }

        .violet {
            color: violet;
        }

        .yellow {
            color: yellow;
        }

        .by {

            float: left;
            width: 50%;
            display: block;
            text-align: center;

        }

        .sa {

            display: block;
            text-align: center;

        }
    </style>
</head>

<body>
    <div>
        <table id="weather">
            <tr>
                <th width="160px" class='name'>Name</th>
                <th width="80px">Höhe</th>
                <th width="80px">Uhrzeit</th>
                <th width="80px"><img src="resources/temp.png" alt="Temp °C" height="64px" width="64px"></th>
                <th width="80px"><img src="resources/wind.png" alt="Wind km/h" height="64px" width="64px"></th>
                <th width="80px"><img src="resources/direction.png" alt="Richtung" height="64px" width="64px"></th>
                <th width="80px"><img src="resources/boe.png" alt="Böe km/h" height="64px" width="64px"></th>
                <th width="80px"><img src="resources/snow.png" alt="HS cm" height="64px" width="64px"></th>
                <th width="80px"><img src="resources/deltasnow.png" alt="HS/24h cm" height="64px" width="64px"></th>
            </tr>
        </table>
        <div id="warnings" class="warnings">
        </div>
        <div id="avalanche" class="avalanche hidden">
            <div id="by" class="by">
            </div>
            <div id="sa" class="sa">
            </div>
        </div>
    </div>
    <script src="https://www.salzburg.gv.at/lawine/Station.js"></script>
    <script>
        var weather_array = []
        fetch("https://weather.services.bergwacht-bayern.org").then(response =>
            response.json().then(json => {
                weather_array.push(generateStation("Kühroint", "kuehroint", "1420", json));
                weather_array.push(generateStation("Watzmannhaus", "watzmann", "1928", json));
                weather_array.push(generateStation("Watzmanngrat", "watzmanngrat", "2635", json));
                weather_array.push(generateStation("Trischübel", "trischuebel", "1764", json));
                weather_array.push(generateStation("Brunftbergtiefe", "brunftbergtiefe", "1240", json));
                weather_array.push(generateStation("Blaueis", "blaueishuette", "1650", json));
                weather_array.push(generateStation("Hinterberghorn", "hinterberghorn", "2493", json));
                weather_array.push(generateStation("Hinterseeau", "hinterseeau", "830", json));

                var table = document.getElementById('weather');

                for (var i = 0; i < weather_array.length; i++) {
                    if (weather_array[i]) {
                        var row = table.insertRow(-1); // -1 is insert as last
                        var cell = row.insertCell(- 1); // -1 is insert as last
                        cell.className = 'title name'; //
                        cell.innerHTML = weather_array[i]['name'];
                        var cell = row.insertCell(- 1); // -1 is insert as last
                        cell.className = 'Altitude'; //
                        cell.innerHTML = weather_array[i]['height'];
                        cell = row.insertCell(- 1); // -1 is insert as last
                        cell.className = 'Time'; //
                        cell.innerHTML = weather_array[i]['time'];
                        cell = row.insertCell(- 1); // -1 is insert as last
                        const lt = weather_array[i]['temp'];
                        if (lt < 3.0) {
                            cell.className = 'LT blue'; //
                        } else if (lt > 25.0) {
                            cell.className = 'LT red'; //
                        }
                        else {
                            cell.className = 'LT'; //
                        }
                        cell.innerHTML = lt;
                        cell = row.insertCell(- 1); // -1 is insert as last
                        const wg = Math.round(weather_array[i]['wind'] * 3.6);
                        if (wg >= 50) {
                            cell.className = 'WG red'; //
                        }
                        else if (wg >= 30) {
                            cell.className = 'WG warning'; //
                        } else {
                            cell.className = 'WG'; //
                        }
                        cell.innerHTML = roundWind(weather_array[i]['wind']);
                        cell = row.insertCell(- 1); // -1 is insert as last
                        cell.className = 'WR'; //
                        cell.innerHTML = getDirection(weather_array[i]['direction']);
                        cell = row.insertCell(- 1); // -1 is insert as last
                        const wgBoe = Math.round(weather_array[i]['wind_boe'] * 3.6);
                        if (wgBoe >= 50) {
                            cell.className = 'WG_BOE red'; //
                        }
                        else if (wgBoe >= 30) {
                            cell.className = 'WG_BOE warning'; //
                        } else {
                            cell.className = 'WG_BOE'; //
                        }
                        cell.innerHTML = roundWind(weather_array[i]['wind_boe']);
                        cell = row.insertCell(- 1); // -1 is insert as last
                        cell.className = 'HS'; //
                        cell.innerHTML = roundToFive(weather_array[i]['snow']);
                        cell = row.insertCell(- 1); // -1 is insert as last
                        if (Math.round(weather_array[i]['snow_delta'] / 5) * 5 > 0) {
                            cell.className = 'HSD24 warning'; //
                        } else {
                            cell.className = 'HSD24'; //
                        }
                        cell.innerHTML = roundToFive(weather_array[i]['snow_delta']);
                    }
                }
            }
            )
        )

        function roundWind(x) {
            if (isNaN(x)) {
                return '-';
            }
            if (x < 0) {
                return 0;
            }
            return Math.round(x * 3.6);
        }

        function getDirection(x) {
            if (isNaN(x)) {
                return '-';
            }
            if (x > 337 || x < 23) {
                return 'N'
            }
            if (x > 22 && x < 68) {
                return 'NO'
            }
            if (x > 67 && x < 113) {
                return 'O'
            }
            if (x > 112 && x < 158) {
                return 'SO'
            }
            if (x > 157 && x < 203) {
                return 'S'
            }
            if (x > 202 && x < 248) {
                return 'SW'
            }
            if (x > 247 && x < 293) {
                return 'W'
            }
            if (x > 292 && x < 338) {
                return 'NW'
            }
            return '-'
        }

        function roundToFive(x) {
            if (isNaN(x)) {
                return '-';
            }
            if (x < 0) {
                return 0;
            }
            return Math.round(x / 5) * 5;
        }

        function generateStation(nameMDS, nameLWD, height, json) {
            temp = json[nameMDS]["values"][height].find(value => value.name == "Lufttemperatur") ? parseFloat(json[nameMDS]["values"][height].find(value => value.name == "Lufttemperatur")["value"]) : NaN;
            wind = json[nameMDS]["values"][height].find(value => value.name == "Windgeschwindigkeit") ? parseFloat(json[nameMDS]["values"][height].find(value => value.name == "Windgeschwindigkeit")["value"]) : NaN;
            direction = json[nameMDS]["values"][height].find(value => value.name == "Windrichtung") ? parseInt(json[nameMDS]["values"][height].find(value => value.name == "Windrichtung")["value"]) : NaN;
            wind_boe = json[nameMDS]["values"][height].find(value => value.name == "Windböe") ? parseFloat(json[nameMDS]["values"][height].find(value => value.name == "Windböe")["value"]) : NaN;
            snow = json[nameMDS]["values"][height].find(value => value.name == "Schneehöhe") ? parseFloat(json[nameMDS]["values"][height].find(value => value.name == "Schneehöhe")["value"]) : NaN;
            return {
                "name": nameMDS,
                "height": height,
                "time": json[nameMDS]["time"].split(' ')[3],
                "temp": temp,
                "wind": wind,
                "direction": direction,
                "wind_boe": wind_boe,
                "snow": snow,
                "snow_delta": stationData['R01 Nordalpen'].find(station => station.name === nameLWD)['measuredData']['values']['HSD24']
            }
        }

    </script>
    <script>
        fetch("https://weather.services.bergwacht-bayern.org/warnings?lat=47.6075&lon=12.8964&level=3").then(response =>
            response.json().then(json => {

                var element = document.getElementById('warnings');
                if (json.length === 0) {
                    var para = document.createElement("p");
                    var node = document.createTextNode("Aktuell keine Unwetterwarnungen");
                    para.appendChild(node);
                    element.appendChild(para);
                } else {
                    for (var i = 0; i < json.length; i++) {
                        var container = document.createElement("div");
                        container.className = "warningContainer";
                        var para = document.createElement("p");
                        if (json[i]['level'] == 2) {
                            para.className = "yellow warningName";
                        } else if (json[i]['level'] == 3) {
                            para.className = "warning warningName";
                        } else if (json[i]['level'] == 4) {
                            para.className = "red warningName"
                        } else if (json[i]['level'] == 5) {
                            para.className = "violet warningName"
                        }
                        var node = document.createTextNode(json[i]['name']);
                        para.appendChild(node);
                        container.appendChild(para);
                        const startDate = new Date(json[i]['start']);
                        const endDate = new Date(json[i]['end']);
                        para = document.createElement("p");
                        if (json[i]['level'] == 2) {
                            para.className = "yellow warningDesc";
                        } else if (json[i]['level'] == 3) {
                            para.className = "warning warningDesc";
                        } else if (json[i]['level'] == 4) {
                            para.className = "red warningDesc"
                        } else if (json[i]['level'] == 5) {
                            para.className = "violet warningDesc"
                        }
                        node = document.createTextNode(startDate.toLocaleString("de-DE", { dateStyle: "short", timeStyle: "short" }) + ' Uhr bis ' + endDate.toLocaleString("de-DE", { dateStyle: "short", timeStyle: "short" }) + ' Uhr');
                        para.appendChild(node);
                        container.appendChild(para);
                        para = document.createElement("p");
                        if (json[i]['level'] == 2) {
                            para.className = "yellow warningDesc";
                        } else if (json[i]['level'] == 3) {
                            para.className = "warning warningDesc";
                        } else if (json[i]['level'] == 4) {
                            para.className = "red warningDesc"
                        } else if (json[i]['level'] == 5) {
                            para.className = "violet warningDesc"
                        }
                        node = document.createTextNode(json[i]['description']);
                        para.appendChild(node);
                        container.appendChild(para);
                        para = document.createElement("p");
                        para.className = "warningCount";
                        node = document.createTextNode((i + 1) + " / " + json.length);
                        para.appendChild(node);
                        container.appendChild(para);
                        element.appendChild(container);
                    }
                    showWarnings();
                }
            }
            )
        )

        var warningIndex = 0;

        function showWarnings() {
            var i;
            var warnings = document.getElementsByClassName("warningContainer");
            for (i = 0; i < warnings.length; i++) {
                warnings[i].style.display = "none";
            }
            warningIndex++;
            if (warningIndex > warnings.length) { warningIndex = 1 }
            warnings[warningIndex - 1].style.display = "block";
            setTimeout(showWarnings, 15000); // Change image every 15 seconds
        }

    </script>
    <script>
        generateAvalancheWarnings('https://www.avalanche-warnings.eu/public/salzburg/caaml', 'AT-05-17', 'sa', 'Salzburg');
        generateAvalancheWarnings('https://www.avalanche-warnings.eu/public/bayern/caaml', 'DE-BY-60', 'by', 'Bayern');

        function generateAvalancheWarnings(url, region, elementId, name) {
            fetch(url)
                .then(function (response) {
                    return response.text();
                })
                .then(function (data) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data, 'text/xml');
                    const warning = getWarningsForRegion(xmlDoc, region);
                    const date = getWarningDate(warning);
                    const ratings = warning.getElementsByTagName('DangerRating');
                    const ratingsAndHeight = getRatingsAndHeight(ratings);
                    if (ratingsAndHeight.length === 0) {
                        return;
                    }
                    if (ratingsAndHeight.length === 1) {
                        const container = document.getElementById('avalanche');
                        container.className = "avalanche";
                        const element = document.getElementById(elementId);
                        let header = document.createElement("p");
                        header.appendChild(document.createTextNode(name));
                        element.appendChild(header);
                        const img = document.createElement("img");
                        img.src = "https://www.avalanche-warnings.eu/images/common/avalanche-levels/danger_" + ratingsAndHeight[0].level + ".svg";
                        img.width = 200;
                        img.alt = ratingsAndHeight[0].level;
                        element.appendChild(img);
                        let para = document.createElement("p");
                        if (ratingsAndHeight[0].height) {
                            para.appendChild(document.createTextNode(ratingsAndHeight[0].height));
                            para.appendChild(document.createElement("br"))
                        }
                        para.appendChild(document.createTextNode(date));
                        element.appendChild(para);
                    } else {
                        const container = document.getElementById('avalanche');
                        container.className = "avalanche";
                        const element = document.getElementById(elementId);
                        let header = document.createElement("p");
                        header.appendChild(document.createTextNode(name));
                        element.appendChild(header);
                        if (new Date(ratingsAndHeight[0].end) < new Date(ratingsAndHeight[1].end)) {
                            const img = document.createElement("img");
                            img.src = "https://www.avalanche-warnings.eu/images/common/avalanche-levels/danger_" + ratingsAndHeight[0].level + ".svg";
                            img.width = 100;
                            img.alt = ratingsAndHeight[0].level;
                            element.appendChild(img);
                            const img2 = document.createElement("img");
                            img2.src = "https://www.avalanche-warnings.eu/images/common/avalanche-levels/danger_" + ratingsAndHeight[1].level + ".svg";
                            img2.width = 100;
                            img2.alt = ratingsAndHeight[1].level;
                            element.appendChild(img2);
                            let para = document.createElement("p");
                            para.appendChild(document.createTextNode("Vormittag - Nachmittag"));
                            if (ratingsAndHeight[0].height) {
                                para.appendChild(document.createElement("br"))
                                para.appendChild(document.createTextNode(ratingsAndHeight[0].height));
                            }
                            para.appendChild(document.createElement("br"))
                            para.appendChild(document.createTextNode(date));
                            element.appendChild(para);
                        } else {
                            const img = document.createElement("img");
                            img.src = "https://www.avalanche-warnings.eu/images/common/avalanche-levels/danger_" + ratingsAndHeight[1].level + ".svg";
                            img.width = 100;
                            img.alt = ratingsAndHeight[1].level;
                            element.appendChild(img);
                            const img2 = document.createElement("img");
                            img2.src = "https://www.avalanche-warnings.eu/images/common/avalanche-levels/danger_" + ratingsAndHeight[0].level + ".svg";
                            img2.width = 100;
                            img2.alt = ratingsAndHeight[0].level;
                            element.appendChild(img2);
                            let para = document.createElement("p");
                            para.appendChild(document.createTextNode("Vormittag - Nachmittag"));
                            if (ratingsAndHeight[1].height) {
                                para.appendChild(document.createElement("br");
                                para.appendChild(document.createTextNode(ratingsAndHeight[1].height));
                            }

                            para.appendChild(document.createElement("br"))
                            para.appendChild(document.createTextNode(date));
                            element.appendChild(para);
                        }
                    }
                }).catch(function (error) {
                    console.log("Fehler: bei Auslesen der XML-Datei " + error);
                });
        }

        function getWarningsForRegion(xmlDoc, region) {
            locRefs = xmlDoc.getElementsByTagName('locRef');
            for (let i = 0; i < locRefs.length; i++) {
                let locRef = locRefs.item(i);
                if (locRef.attributes['xlink:href']['value'] === region) {
                    return locRef.parentElement;
                }
            }
        }
        function getRatingsAndHeight(ratings) {
            const tempRatings = generateTempRatings(ratings);
            if (tempRatings.length === 1) {
                return [{ level: tempRatings.level, height: null }];
            } else if (tempRatings.length > 1) {
                const hiRatings = tempRatings.filter(rating => rating.elevation.endsWith('Hi'));
                const loRatings = tempRatings.filter(rating => rating.elevation.endsWith('Lo'));
                if (hiRatings.length == 1) {
                    let height = "Waldgrenze"
                    let elevation = hiRatings[0].elevation.substring(0, hiRatings[0].elevation.length - 2);
                    if (elevation !== "Forestline") {
                        height = elevation + "m";
                    }
                    let level = loRatings[0].level;
                    if (loRatings[0].level !== hiRatings[0].level) {
                        level += hiRatings[0].level;
                    }
                    return [{ level: level, height: height }];
                }
                if (hiRatings[0].end === loRatings[0].end) {
                    let height = "Waldgrenze"
                    let elevation = hiRatings[0].elevation.substring(0, hiRatings[0].elevation.length - 2);
                    if (elevation !== "Forestline") {
                        height = elevation + "m"
                    }
                    let level = loRatings[0].level;
                    if (loRatings[0].level !== hiRatings[0].level) {
                        level += hiRatings[0].level
                    }
                    let height2 = "Waldgrenze"
                    let elevation2 = hiRatings[1].elevation.substring(0, hiRatings[1].elevation.length - 2);
                    if (elevation2 !== "Forestline") {
                        height2 = elevation2 + "m"
                    }
                    let level2 = loRatings[1].level;
                    if (loRatings[1].level !== hiRatings[1].level) {
                        level2 += hiRatings[1].level
                    }
                    return [{ level: level, height: height, end: hiRatings[0].end }, { level: level2, height: height2, end: hiRatings[1].end }];
                } else {
                    let height = "Waldgrenze"
                    let elevation = hiRatings[0].elevation.substring(0, hiRatings[0].elevation.length - 2);
                    if (elevation !== "Forestline") {
                        height = elevation + "m"
                    }
                    let level = loRatings[1].level;
                    if (loRatings[1].level !== hiRatings[0].level) {
                        level += hiRatings[0].level
                    }
                    let height2 = "Waldgrenze"
                    let elevation2 = hiRatings[1].elevation.substring(0, hiRatings[1].elevation.length - 2);
                    if (elevation2 !== "Forestline") {
                        height2 = elevation2 + "m"
                    }
                    let level2 = loRatings[0].level;
                    if (loRatings[0].level !== hiRatings[1].level) {
                        level2 += hiRatings[1].level
                    }
                    return [{ level: level, height: height, end: hiRatings[1].end }, { level: level2, height: height2, end: hiRatings[0].end }];
                }
            }
            return [];
        }

        function getWarningDate(warning) {
            return new Date(warning.getElementsByTagName('dateTimeReport')[0].innerHTML).toLocaleDateString("de-DE");
        }

        function generateTempRatings(ratings) {
            let temp = [];
            for (let i = 0; i < ratings.length; i++) {
                let end = null;
                if (ratings.item(i).getElementsByTagName('endPosition').length > 0) {
                    end = ratings.item(i).getElementsByTagName('endPosition')[0].innerHTML;
                }
                let elevation = null;
                if (ratings.item(i).getElementsByTagName('validElevation').length > 0) {
                    elevation = ratings.item(i).getElementsByTagName('validElevation')[0].attributes['xlink:href']['value'].split("Range_")[1];
                }
                temp.push({ end: end, elevation: elevation, level: ratings.item(i).getElementsByTagName('mainValue')[0].innerHTML });
            }
            return temp;
        }
    </script>
</body>

</html>
